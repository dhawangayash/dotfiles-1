#!/bin/zsh
# milomouse <vincent[at]fea.st>
# NOTE: simple download handler using curl. uses ratpoison (only for notifications).

uagent="Uzbl (Webkit 1.1.22) ($(uname -o) $(uname -m) [$(uname -m)])"
cjar="$XDG_DATA_HOME/uzbl/cookies.txt"
url="$8"
basedir=$(dirname "$url"|tr ' ' '_'|tr '/' '\n'|sed '3,$!d;$d'
basename=$(print "$url"|tr ' ' '_'|tr '/' '\n'|sed '$!d')

# change $dest on special occassions, else put the download into
# a directory named after the parent website so as not to clobber:
if [[ -n $(print $url|grep -E '.*\.torrent') ]]; then
  dest="$HOME/tors"
elif [[ -n $(print $url|grep -i '.*\.png\|.*\.jpg\|.*\.jpeg\|.*\.gif\|.*\.tiff\|.*\.svg') ]]; then
  dest="$XDG_PICTURES_DIR"
else
  dest="$XDG_DOWNLOAD_DIR/$basedir"
fi

# start download..
ratpoison -c "echo Downloading, please wait.."
curl -s --user-agent $uagent --ssl -k --retry 3 --retry-delay 11 -c $cjar --max-redirs 1 --create-dirs -C - "$url" -o "$dest/$basename"
ratpoison -c "echo Download complete."
