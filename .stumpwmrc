;;--------------------------------------------------------------------------;;
;; ${HOME}/.stumpwmrc                                                       ;;
;;--------------------------------------------------------------------------;;
;; author: milomouse <vincent[at]fea.st>                                    ;;
;; update: 2010-12-02 06:35:34                                              ;;
;;--------------------------------------------------------------------------;;
;; versions used atoc:                                                      ;;
;; |  sbcl              -> 1.0.43-1                                         ;;
;; |  clx               -> 0.7.4-1                                          ;;
;; |  cl-ppcre          -> 2.0.3-1                                          ;;
;; |  stumpwm-git       -> 20101109-1                                       ;;
;;-TODO:--------------------------------------------------------------------;;
;; >>>-: create a 'dedicate' and 'catchall' window-rule (remember * *)      ;;
;; >>--: create a 'dedicate' and 'catchall' hook for changing focus color   ;;
;; >>--: have mifo(mplayer-daemon) prompts use filename completion          ;;
;; >---: better resize; if neighbour {above} then -ARG else +ARG, etc.      ;;
;; >>>-: show frame-indicator for 'resize' only if no window in frame       ;;
;; >>--: command-mode for mifo video:seek to eliminate extra key-presses    ;;
;; >---: have my 'undo' use group and check current group for undos first   ;;
;; >>>>? command for dedicating current win/frame as the Master win/frame   ;;
;; >>>>! command for swapping current window with the Master win/frame      ;;
;; >>>>! exchange two windows but keep focus in current frame               ;;
;;--------------------------------------------------------------------------;;
;; files: *data-dir*/../{commands,functions,hooks,key-maps,macros}.lisp     ;;
;;-NOTE:--------------------------------------------------------------------;;
;; 1. for MPlayer, use: mplayer -nokeepaspect {-fstype netwm}               ;;
;; 2. using SBCL now due to stability issues with clisp-new-clx             ;;
;; 3. had to rework most files to accomodate SBCL's finicky handling        ;;
;;--------------------------------------------------------------------------;;

(in-package :stumpwm)

;; set data-dir for storing debug-file, group and placement dumps, etc.
(setf *data-dir* (make-pathname :directory
                 '(:relative ".config" "stumpwm" "storage"))
      *debug-level* 1)

;; setup a quick function for redirecting debug information directly to file.
;; (didn't want to use (redirect-all-output) as that's not what i want..)
;; (prefer internal handling as opposed to redirecting via exec $ >>! file)
(defvar *debug-restream* nil)
(defun redirect-debug (file) "Redirect *debug-stream* directly to a file."
  (when (typep *debug-restream* 'file-stream)
    (close *debug-restream*))
  (setf *debug-restream* (open file :direction :output :if-exists :append
                         :if-does-not-exist :create)
        *debug-stream* *debug-restream*))

;; setup debug-file variable for referencing (e.g. quitting) purposes.
(defvar *debug-file* (data-dir-file "log" "lisp"))
(redirect-debug *debug-file*)

;; redefine run-shell-command for 'zsh', change :shell "", and fix a typo.
(defcommand run-shell-command (cmd &optional collect-output-p)
  ((:shell "execute: "))
  "Run the specified shell command. If @var{collect-output-p} is @code{T}
then run the command synchronously and collect the output."
  (if collect-output-p
    (run-prog-collect-output *shell-program* "-c" cmd)
    (run-prog *shell-program* :args (list "-c" cmd) :wait nil)))
(setf *shell-program* "/bin/zsh")
(defcommand-alias exec run-shell-command)

;; define a background-image-path for random image setting function.
;; (will soon change this to accept optional sub-dir for situations where user
;; wants to use 'work' or 'family' wallpapers instead)
(defvar *background-image-path*
  (merge-pathnames
    (make-pathname :directory '(:relative "foto" "wall"))
    *default-pathname-defaults*))

;; set undo directory to store each group undo state. still a work in progress
;; as far as the function goes, currently only undos as a bulk screen process.
;; (will soon change this to undo on a per group basis)
(defvar *undo-data-dir* (make-pathname :directory "/dev/shm/.1000"))

;; gravities.
(setf *mouse-focus-policy* :click
      *window-border-style* :thin
      *message-window-gravity* :top-right
      *input-window-gravity* :top-right)
(set-normal-gravity :bottom)
(set-maxsize-gravity :center)
(set-transient-gravity :bottom)

;; borders.
(setf *resize-hides-windows* T
      *normal-border-width* 2
      *maxsize-border-width* 2
      *transient-border-width* 2
      *float-window-border* 1
      *float-window-title-height* 1)
(set-msg-border-width 1)

;; fonts/colors.
(set-font "-*-fixed-medium-r-normal-*-10-*-*-*-*-*-*-*")
(set-fg-color        "grey64")
(set-bg-color        "grey14")
(set-focus-color     "mediumpurple2")
(set-unfocus-color   "grey16")
(set-border-color    "grey44")
(set-win-bg-color    "grey4")
(setf *colors* (list "grey9"          ; 0 black
                     "palevioletred1" ; 1 red
                     "lightblue3"     ; 2 green
                     "bisque3"        ; 3 yellow
                     "steelblue3"     ; 4 blue
                     "slateblue1"     ; 5 magenta
                     "aquamarine4"    ; 6 cyan
                     "honeydew4"      ; 7 white
                     "thistle4"       ; 8 user
                     "lightskyblue4")); 9 user
(defun fmt-group-status (group)
  (let ((screen (group-screen group)))
    (cond ((eq group (screen-current-group screen))
           #\*)
          ((and (typep (second (screen-groups screen)) 'group)
                (eq group (second (screen-groups screen))))
           #\+)
          (t #\-))))
(update-color-map (current-screen))

;; text formatting (no mode-line). shorten time-day-names, etc.
(setf *startup-message*
       "^B^1*together we ate the king^n:^B^5*and laughed ourselves to death^n"
      *screen-mode-line-format* nil
      *time-day-names* #("Mon" "Tue" "Wed" "Thu" "Fri" "Sat" "Sun")
      *time-format-string-default* "^B^2*%T^9* %Y-%m-%d^**/^8*%A^n"
      *group-format*    "^B^0*%t^7*%s^07|^n"
      *window-format*   "^B^87%s^9*%m^0*%16t^n"
      *timeout-wait* 6)

;; windows/frames. use more intuitive frame-numbers (with 'fselect' <s-y>).
(setf *default-window-name* "null"
      *normal-gravity* :top-right
      *maxsize-gravity* :top-right
      *transient-gravity* :center
      *new-frame-action* :empty
      *min-frame-width* 50
      *min-frame-height* 50
      *resize-increment* 5
      *frame-number-map* "yhjukilop")

;; mode-line/input.
(setf *mode-line-background-color* "grey13"
      *mode-line-border-color* "grey25"
      *mode-line-foreground-color* "azure4"
      *mode-line-border-width* 1
      *mode-line-pad-x* 1
      *mode-line-pad-y* 0
      *mode-line-timeout* 1
      *mode-line-position* :top
      *input-history-ignore-duplicates* 0)

;; load external settings files. these are the bulk of setup/optimizations.
(loop for file in '("functions" "macros" "commands" "hooks" "key-maps")
      do (load (make-pathname :name file :type "lisp"
      :directory '(:relative ".config" "stumpwm"))))

;; set first group as 1, then create every other group in background.
(setf (group-name (first (screen-groups (current-screen)))) "1")
(make-groups-bg "2" "3" "4" "5" "6")

;; restore data from previous exit (state StumpWM was last using).
(clear-window-placement-rules)
(restore-from-file (data-dir-file "desktop_data"))
(restore-window-placement-rules (data-dir-file "placement_rules"))

;; display a random background image on root window.
;(display-random-bg)

